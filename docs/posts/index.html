<!DOCTYPE html>
<html lang="zh" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.82.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Posts" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hitzhangjie.pro/go-internals-v2/posts/" />

<title>Posts | Go设计实现内幕</title>
<link rel="manifest" href="/go-internals-v2/manifest.json">
<link rel="icon" href="/go-internals-v2/favicon.png" type="image/x-icon">
<link rel="alternate" hreflang="en" href="https://hitzhangjie.pro/go-internals-v2/en/posts/" title="Notes">

<link rel="stylesheet" href="/go-internals-v2/book.min.5ac6c2989f0943405962be6800b442aef429ef26ade26545ecf0617a21d1197a.css" integrity="sha256-WsbCmJ8JQ0BZYr5oALRCrvQp7yat4mVF7PBheiHRGXo=">
<script defer src="/go-internals-v2/zh.search.min.11c7f9052a0367999d4ad7c1d4a6e855fff004ebbb45683eed1b2e9995a0bd03.js" integrity="sha256-Ecf5BSoDZ5mdStfB1KboVf/wBOu7RWg&#43;7RsumZWgvQM="></script>

<script defer src="/go-internals-v2/sw.min.e3f8d329ac7f45d9b3ff588e83620122ab38761b68b73d194944ff43613a3b8d.js" integrity="sha256-4/jTKax/Rdmz/1iOg2IBIqs4dhtotz0ZSUT/Q2E6O40="></script>
<link rel="alternate" type="application/rss+xml" href="https://hitzhangjie.pro/go-internals-v2/posts/index.xml" title="Go设计实现内幕" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/go-internals-v2"><img src="/go-internals-v2/logo.png" alt="Logo" /><span>Go设计实现内幕</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/preface/" class="">前言</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/table-of-contents/" class="">Table of Contents</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/table-of-contents/with-toc/" class="">With ToC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/table-of-contents/without-toc/" class="">Without ToC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e95c4460caffb600f4fbaa5e481c2b3b" class="toggle"  />
    <label for="section-e95c4460caffb600f4fbaa5e481c2b3b" class="flex justify-between">
      <a  class="">Collapsed</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/collapsed/3rd-level/" class="">3rd Level</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/collapsed/3rd-level/4th-level/" class="">4th Level</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d4bb91610a9265767097cfd2097f9869" class="toggle"  />
    <label for="section-d4bb91610a9265767097cfd2097f9869" class="flex justify-between">
      <a  class="">Compiler</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/aliases-simple-and-efficient/" class="">aliases, simple and efficient</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/builds-linkers-timeline/" class="">builds &amp; linker&#34;s timeline</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/built-in-functions-optimizations/" class="">built-in functions optimizations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/how-go-build-works/" class="">how &#34;go build&#34; works</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/how-are-loops-translated-to-assembly/" class="">how are loops translated to assembly</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/how-to-take-advantage-of-symbols-tables/" class="">how to take advantage of symbols tables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/inline-strategy-limitation/" class="">inline strategy &amp; limitation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/introduction-to-the-escape-analysis/" class="">introduction to the escape analysis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/introduction-to-the-go-compiler/" class="">introduction to the go compiler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/introduction-to-the-go-compiler-ssa-backend/" class="">introduction to the go compiler ssa backend</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/memory-safety-with-bounds-check/" class="">memory safety with bounds check</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/overview-of-the-compiler/" class="">overview of the compiler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/slice-and-memory-management/" class="">slice and memory management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/go-internals-v2/docs/compiler/understanding-compiler-directives/" class="">understanding compiler directives</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f31e09d220fe3252a0eb99bdea817893" class="toggle"  />
    <label for="section-f31e09d220fe3252a0eb99bdea817893" class="flex justify-between">
      <a  class="">Runtime</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>











<hr>


  
<ul>
  
  <li>
    <a href="/go-internals-v2/posts/" >
        Posts
      </a>
  </li>
  
  <li>
    <a href="https://github.com/hitzhangjie/go-internals-v2" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://hitzhangjie.pro" target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/go-internals-v2/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Posts</strong>

  <label for="toc-control">
    
    <img src="/go-internals-v2/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/ast/">ast</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/chan/">chan</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/chan-select-case/">chan, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/closure/">closure</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/compiler/">compiler</a>
          <span>24</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/compiler-linker/">compiler, linker</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/concurrency/">concurrency</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/context/">context</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/debug/">debug</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer/">defer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer-panic/">defer, panic</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer-panic-recover/">defer, panic, recover</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/diagnostics/">diagnostics</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/fuzzy-test/">fuzzy, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/garbage-collector/">garbage collector</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine/">goroutine</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine-gpm-scheduler/">goroutine, gpm scheduler</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine-select-case/">goroutine, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/gpm-scheduler/">gpm scheduler</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/init/">init</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/instrumentation/">instrumentation</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/interface/">interface</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/linker/">linker</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/locks/">locks</a>
          <span>3</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/map/">map</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/map-race-detector/">map, race detector</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/mechanics/">mechanics</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/memory-management/">memory management</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/monitor/">monitor</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/pointer/">pointer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/pprof/">pprof</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/race-detector/">race detector</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/random/">random</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/string/">string</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/sync.pool/">sync.pool</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/syscall/">syscall</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/tdd-test/">tdd, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/test/">test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/timer/">timer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/trace/">trace</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/unsafe/">unsafe</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/a-race-detector-unfurled/">a race detector unfurled</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/race-detector/">race detector</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  Talk by Kavya Joshi. Race detectors are seriously cool tools that make writing race-free concurrent code easy — they detect the ever so elusive race conditions in a program. The Go race detector is one such tool that ships with Go, thereby making the magic of race detection trivially accessible to you and me. This talk will present the subtleties of race detection and explore how the Go race detector does it.
        <a href="/go-internals-v2/posts/a-race-detector-unfurled/">...</a>
      
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/aliases-simple-and-efficient/">aliases, simple and efficient</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/compiler/">compiler</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  go提供了定义类型别名的能力，type A = B，这样就将A定义为了类型B的别名，后面可以使用A来代替类型B。有什么好处呢：
 做一些重构类的工作，假如之前代码中有个类型Type1被大量使用，现在重新实现了一个类型Type2希望能替换掉Type1，可以在使用Type1的地方通过type Type1 = Type2来创建一个别名已完成重构（当然也可以不用这种方式）； 提高可读性，比如有些函数的参数可能是一个函数，如filepath.Walk(path, func(fp string, inf os.FileInfo, err error) error)，现在还好，如果参数更多些就很难看了，如果定义type WalkFunc = func(fp string, inf os.FileInfo, err error) error，然后filepath.Walk(path, WalkFunc)`可读性就大大提升了；  运行时会对type alias做何处理呢？比如type A = B，如果给一个emptyInterface赋值了一个变量A：
 那么类型断言它应该是A还是B呢？都必须断言成功！ 那么反射获取其类型应该是谁呢？应该是B！ 到底是如何处理的呢？编译器会在编译时，将对尝试需要类型A的地方使用类型B的信息，处理起来就简单了。  Source Analysis #  References #   https://medium.com/a-journey-with-go/go-aliases-simple-and-efficient-8506d93b079e  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/an-insight-into-go-garbage-collector/">an insight into go garbage collector</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/garbage-collector/">garbage collector</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  goroutine栈内存是从mheap申请而来，栈空间小于32K的时候也是从P.mcache中分配的，减小锁竞争，当栈空间大于32K时就从mheap中分配了。/// stack split指的是stack growth和stack shrink这种情况。/// stack销毁开销更小，调整下栈指针寄存器即可。heap对象销毁则要依赖垃圾回收。/// 并发三色标记清除算法，黑色表示可达并且已经分析完了其内部指针的对象，灰色表示可达但是还没有分析完其内部指针，白色表示不可达对象。为了维持三色不变性需要通过write barrier来记录mutator对指针做的修改，新版本中已经是用的混合写屏障了，综合了dijkstra write barrier和yuasa write barrier，并且做了优化实现了bufferred write barrier，允许每个P维护一个buffer必要时flush以提GC性能。/// go GC追求更低的停顿时间，希望GC给goroutine执行引入的延迟更低！
Source Analysis #  References #   https://golangpiter.com/system/attachments/files/000/001/718/original/GP_2019_-_An_Insight_Into_Go_Garbage_Collection.pdf?1572419303  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/asynchronous-preemption/">asynchronous preemption</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/goroutine/">goroutine</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  这里的异步抢占，就是我们说的抢占式调度了，是通过SIGURG信号、信号处理、协程调度来共同实现的。
首先，正如前面介绍的，go程序中有一个sysmon线程，它会定期检查所有的P，检查其是否运行时间超过了10ms，如果超过了则执行抢占逻辑，preemptone(p)，其内部其实是设置P上当前g的preempt标记位为true，然后再尝试去抢占p.m，preemptM(p.m)，这个preemptM内部会给m这个线程发送一个SIGURG信号。
前面介绍gsignal时我们提过了，sighanlder这里会区分信号类型并做处理，这里的SIGURG信号就是go中选定的抢占式信号sigPreempt，然后执行抢占逻辑，这个逻辑也简单，就是保存当前g上下文，并切换到g0，g0选择下一个要调度的g并恢复其上下文执行。抢占就完成了。
关于为什么抢占信号选择SIGURG，也不是凭空选的，主要是考虑了下面几点： It should be a signal that’s passed-through by debuggers by default.
 It shouldn’t be used internally by libc in mixed Go/C binaries […]. It should be a signal that can happen spuriously without consequences. We need to deal with platforms without real-time signals […].  异步抢占，可以通过设置环境变量来关闭，GODEBUG=asyncpreemptoff=1.
Source Analysis #  SIGURG，在信号处理函数runtime/signal_unix.go:sighandler(&hellip;)函数中又看到对sigPreempt的处理。
SIGURG实现抢占式调度： 对应这个函数doSigPreempt，检查当前g是不是wantAsyncPreempt，ok的话检查是不是isAsyncSafePoint，ok的话，sigctxt.pushCall(funcPC(asyncPreempt), newpc)，这个函数调整PC并注入一个对asyncPreempt的调用。
TODO wantAsyncPreempt对应的判断参数是谁去设置的，什么时候设置的？
TODO isAsyncSafePoint，safepoint的含义？这个函数的注释以及代码中的if-else已经足够结实清楚什么是safepoint了，以及safepoint的意义了。
看下asyncPreempt的逻辑，该函数是在汇编中实现的，首先保存寄存器的值，然后调用asyncPreempt2执行其他处理。
g.preemptStop决定是挂起g还是重新调度g：
 如果被抢占的g的g.
        <a href="/go-internals-v2/posts/asynchronous-preemption/">...</a>
      
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/buffered-and-unbuffered-channels/">buffered and unbuffered channels</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/chan/">chan</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  src/runtime/chan.go中hchan，bufferedChan和unbufferedChan都是用这个数据类型来表示。
1 unbuffered chan
unbufferedChan：创建chan时没有指定capacity或者capacity=0，这样的chan是无缓冲的。chan sender执行chan send操作时会阻塞，直到chan reader读取了该数据。
chan sender阻塞时，会申请一个sudog，记录chan sender对应的g，并记录chan sender要send的value，chan reader读取时直接通过memmove移动sudog中记录的数据到chan reader要read到的变量中，并resume sudog记录的g。
2 buffered chan
bufferedChan：创建chan时指定了capacity≥1：
 chan sender执行send操作时，如果chan满了则会阻塞； chan reader执行read操作时，如果chan空了则会阻塞；  hchan中有记录当前chan中元素数量hchan.qcount，并通过hchan.dataqsiz记录capacity，通过一个环形队列hchan.buf来存储存储的元素数量，该环形队列通过hchan.sendx/hchan.recvx来记录下次chan send操作的写入位置和下次chan read操作时的读取位置。
和unbufferedChan类似，如果chan sender、chan reader要阻塞时需要申请sudog并记录到sendq、recvq中。
 后续chan中有空位可写入时，再选择sendq中的某个sudog并memmove其send的value然后resume其执行； 或者chan中有数据可读取时，再选择recvq中的某个sudog并memmove hchan.buf[recvx]中数据到要读取到的变量然后resume其执行；  大致实现过程就是这样的。
3 性能问题
chan buffer的大小、有无，chan sender、receiver的数量，会影响到chan send、recv的性能，这个buffer大小不能凭空臆想，要结合经验、benchmark来指定一个合理的值。
Source Analysis #  References #   https://medium.com/a-journey-with-go/go-buffered-and-unbuffered-channels-29a107c00268  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/build-a-better-linker/">build a better linker</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/linker/">linker</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  介绍了当前go编译器链接器工作过程中做的不太好的地方，以及提出了构建一个更好的链接器的想法。现在已经在这么演进了吧。
Source Analysis #  References #   http://golang.org/s/better-linker  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/builds-linkers-timeline/">builds &amp; linker&#34;s timeline</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/compiler-linker/">compiler, linker</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  go build涉及到的工作步骤包括：
 创建临时工作目录； 编译各个package及其依赖； 链接器连接成可执行程序； 将可执行程序移动到当前目录，并删除临时工作目录；  go build -x会显示整个编译过程中执行的命令，在编译链接过程中，由于编译可能会涉及到应用编译缓存，链接器链接部分的耗时则会变得很突出，如何优化链接器提升其效率就变得很重要。
linker的目的是为了构建一个可执行程序，其步骤包括：
 加载已经编译好的各个package及其依赖，并收集其中的符号信息； 移除deadcode，如所有未使用的函数，这个过程无法在编译阶段完成，因为编译阶段是各个package独立编译的，不知道它们之间的依赖关系，只有链接器知道； DWARF调试信息生成，并将其压缩存储到二进制程序中； 组织好pc-value表，function表，符号表，方便内部使用； 重定位，编译阶段因为是独立编译各package，引用的其他package中的函数的具体位置是不知道的，只有在最后这个阶段链接器能知道，要靠链接器把函数调用出替换为准确的函数地址。 最后一个可执行程序就生成了。  linker也分为internal linker和external linker，涉及到cgo调用、生成共享库等的时候会使用external linker，其他情况会默认使用internal linker。
可以给linker传递选项来减轻链接阶段的耗时，如go build -ldflags=&quot;-w&quot; or go tool link -w 来禁用调试信息生成，internal linker还支持对生成的调试信息进行压缩，如go build -ldflags=&quot;dwarfcompress=true&quot;。
go之前提供的linker实现不能说完美吧，所以也有构建更好的linker的想法，详情可见：http://golang.org/s/better-linker。
Source Analysis #  References #   https://medium.com/a-journey-with-go/go-builds-linkers-timeline-b312084ddf7d  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/built-in-functions-optimizations/">built-in functions optimizations</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/compiler/">compiler</a>
  </div>
  




    <p>Let&rsquo;s Summarize #    len、cap函数 slice对应的len、cap操作，其实是没有对应的函数体实现的。编译器会跟踪对slice的操作，从而能够直接获取到其len、cap。如果是slice作为参数，编译器会直接根据内存中sliceheader的字段len、cap字段来获取；
  unsafe.Sizeof\Alignof\Offsetof 这几个函数也没有对应的函数体实现，Sizeof返回的是描述符的大小，如sliceheader的大小而非占用的所有内存大小，所以编译器是可以直接知道大小的，包括其对齐方式、内部字段的偏移量；
  Source Analysis #  系统内置函数有不少都是编译器层面实现的，builtin.go中只是添加一些godoc注释，方便开发者使用： https://sourcegraph.com/github.com/golang/go@f24eac47710b0170fd45611ab1867e87701e0a95/-/blob/src/builtin/builtin.go#L6。
真正的实现要看编译器里面的操作，下面以cap为例进行说明。编译器会将源代码进行词法分析、语法分析、语义分析，最终生成AST，AST中每个节点Node代表了源码中的某种程序构造，比如cap(x)这里的cap函数对应的是节点类型OpSliceCap，编译器处理的时候会将其转换为OpCopy cap，cap取自SliceMake ptr len cap中的cap，还有len、copy等函数都是按照类似的方式来实现的。
References #   https://medium.com/a-journey-with-go/go-built-in-functions-optimizations-70c5abb3a680  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/concurrency-scheduler-affinity/">concurrency &amp; scheduler affinity</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/goroutine/">goroutine</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  GM模型
go1.1之前的调度模型是GM模型，有一个全局goroutine队列global queue，它的问题是：
 访问global queue中的g，需要通过一个全局锁，锁粒度大，锁竞争严重； global queue中的g被恢复执行后，不一定在原来的线程上恢复，也不一定在原来的核上执行，cache命中率低；  GMP模型
go1.1开始，引入了新的调度器实现GMP模型，引入了一个局部的local queue，这个改进能够在P local queue有g时避免去锁定global queue，也就减少了锁定了整个scheduler的情况。
goroutine调度粘性
破坏了调度粘性
因为引入了P，M会优先执行P下的local queue中的g，g调度到哪个m执行就有了一定的调度粘性（affinity），但是这个调度粘性也会在某几种情况下被打破，比如：
  GMP是一个work-stealing调度器，m会在本地P local queue空时，尝试从其他地方获取一部分g来运行，比如从global queue，这里没有的话还会从netpoller中获取网络IO事件就绪的g，再没有就从其他P的local queue中获取一部分，这样相当于其他P的g没有在原来P关联的M上执行，打破了这里的调度粘性；
  系统调用，当一个系统调用发生时（文件操作、http调用、数据库操作等），go会将当前正在运行的操作系统线程给挂起（不可中断等待状态），并且会创建一个新的操作系统线程M来处理这个P上的local queue中的g，后续执行系统调用的线程恢复后有可能会去处理其他P上的g，这也打破了这里的调度粘性；
  保护调度粘性
为了减少打破这里的调度粘性，这两个限制可以尽可能去避免，以优化性能。
g、m之间的粘性，m、p之间的粘性，说白了都跟运行时依赖的缓存数据有关系，如果打破了粘性，缓存命中率下降，性能就会受影响，这个很好理解。所以go中也针对上述问题做了优化，比如一个陷入阻塞系统调用的m恢复执行后可以通过steal或者retake的方式来争取获取原来的P，也是一个办法吧，这部分了解就可以了。
对于chan send/recv引起的goroutine阻塞恢复问题，如果goroutine恢复后排在P的local queue的末尾，如果前面有其他goroutine执行，那么大概率这个goroutine会被其他的P上的M偷走，那么当前这个g就要和之前的M、P脱离关系了，一些缓存数据就无法复用了，为了减少打破这里的粘性，赋予了chan阻塞恢复的g更大的调度优先级，比如不将其放到P的local queue，而是将其放到P的runnext中，这样下次就可以立即执行了。
调度粘性的优势
p上有mcache、gFree，m上有tls，m运行g申请小于32K的内存是从p.mcache中分配，维持g、m、p之间的关系有助于复用之前p上建立的mcache，也有助于m创建新的g时复用p上之前维护的空闲g列表。
当然可能还有一些其他的原因，这里暂时先不展开了，想全了再展开。TODO
see：https://sourcegraph.com/github.com/golang/go/-/blob/src/runtime/runtime2.go#L613
Source Analysis #  References #   https://medium.com/a-journey-with-go/go-concurrency-scheduler-affinity-3b678f490488  
    </p>
  </article>
  
  <article class="markdown book-post">
    <h2>
      <a href="/go-internals-v2/posts/concurrent-access-with-maps-part-3/">concurrent access with maps - part 3</a>
    </h2>
    


  

  
  <div>
    
      <a href="/go-internals-v2/tags/map-race-detector/">map, race detector</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  1 map
map中的并发读写问题，go提供了如下方式进行检查：
  data race detection：通过选项-race来检测是否存在data race，关于data race检测的问题，kavya joshi的分享里有介绍；
  并发写操作检测：map对应的数据结构hmap中有个字段flags来记录当前的map操作，比如当前执行m[1]=1，是一个kv的赋值，对应的函数是mapassign_fast64，如果执行的是delete(m, 1)，对应的函数是mapdelete_fast64，这里的map修改操作对应的函数内部会将hmap.flags^=hashWriting，如果已经有一个写操作在执行，后面又有一个写操作执行，后面的写操作就有很大概率检测到flags的hashWriting位被设置了，此时就会抛出错误“concurrent map writes”错误；
  关于map为什么不直接提供并发安全的版本，原因也简单。并发安全的版本是有同步开销的，但是很多时候并不需要并发安全的版本，如果默认实现是并发安全的，性能上就要大打折扣了。不考虑并发安全问题的话，map比sync.Map要快7~10倍。
2 sync.Map
sync.Map是并发安全的实现，它对某些场景下的并发读写做了性能方面的优化： goblogs: &ldquo;The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, (2) when multiple goroutines read, write and overwrite entries for disjoint sets of keys.
        <a href="/go-internals-v2/posts/concurrent-access-with-maps-part-3/">...</a>
      
    </p>
  </article>
  

  
<ul class="pagination">
  <li class="page-item">
    <a href="/go-internals-v2/posts/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
  </li>
  <li class="page-item disabled">
    <a  class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
  </li>
  <li class="page-item active">
    <a class="page-link" href="/go-internals-v2/posts/">1</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="/go-internals-v2/posts/page/2/">2</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="/go-internals-v2/posts/page/3/">3</a>
  </li>
  <li class="page-item disabled">
    <span aria-hidden="true">&nbsp;&hellip;&nbsp;</span>
  </li>
  <li class="page-item">
    <a class="page-link" href="/go-internals-v2/posts/page/9/">9</a>
  </li>
  <li class="page-item">
    <a href="/go-internals-v2/posts/page/2/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
  </li>
  <li class="page-item">
    <a href="/go-internals-v2/posts/page/9/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
  </li>
</ul>


 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  


  


<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="/go-internals-v2/svg/translate.svg" class="book-icon" alt="Languages" />
      Chinese
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="active">
      <a href="https://hitzhangjie.pro/go-internals-v2/" class="flex align-center">
        <img src="/go-internals-v2/svg/translate.svg" class="book-icon" alt="Languages" />
        Chinese
      </a>
    </li>
    
    <li class="">
      <a href="https://hitzhangjie.pro/go-internals-v2/en/posts/" class="flex align-center">
        <img src="/go-internals-v2/svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>






  <div>
    <a class="flex align-center" href="https://github.com/hitzhangjie/go-internals/edit/master//content/posts/_index.md" target="_blank" rel="noopener">
      <img src="/go-internals-v2/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>编辑本页</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/ast/">ast</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/chan/">chan</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/chan-select-case/">chan, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/closure/">closure</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/compiler/">compiler</a>
          <span>24</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/compiler-linker/">compiler, linker</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/concurrency/">concurrency</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/context/">context</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/debug/">debug</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer/">defer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer-panic/">defer, panic</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/defer-panic-recover/">defer, panic, recover</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/diagnostics/">diagnostics</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/fuzzy-test/">fuzzy, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/garbage-collector/">garbage collector</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine/">goroutine</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine-gpm-scheduler/">goroutine, gpm scheduler</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/goroutine-select-case/">goroutine, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/gpm-scheduler/">gpm scheduler</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/init/">init</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/instrumentation/">instrumentation</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/interface/">interface</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/linker/">linker</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/locks/">locks</a>
          <span>3</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/map/">map</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/map-race-detector/">map, race detector</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/mechanics/">mechanics</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/memory-management/">memory management</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/monitor/">monitor</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/pointer/">pointer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/pprof/">pprof</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/race-detector/">race detector</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/random/">random</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/string/">string</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/sync.pool/">sync.pool</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/syscall/">syscall</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/tdd-test/">tdd, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/test/">test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/timer/">timer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/trace/">trace</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/go-internals-v2/tags/unsafe/">unsafe</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>

 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












