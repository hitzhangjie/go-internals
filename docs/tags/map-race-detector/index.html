<!DOCTYPE html>
<html lang="zh" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.82.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="map, race detector" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hitzhangjie.pro/tags/map-race-detector/" />

<title>map, race detector | Go设计实现内幕</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.5ac6c2989f0943405962be6800b442aef429ef26ade26545ecf0617a21d1197a.css" integrity="sha256-WsbCmJ8JQ0BZYr5oALRCrvQp7yat4mVF7PBheiHRGXo=">
<script defer src="/zh.search.min.4a47667c0c4c4d38d4c2f1cb693c0ab48a1a196b65c1be71c0503332ee91b6fa.js" integrity="sha256-SkdmfAxMTTjUwvHLaTwKtIoaGWtlwb5xwFAzMu6Rtvo="></script>

<script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk="></script>
<link rel="alternate" type="application/rss+xml" href="https://hitzhangjie.pro/tags/map-race-detector/index.xml" title="Go设计实现内幕" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/logo.png" alt="Logo" /><span>Go设计实现内幕</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/preface/" class="">前言</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/introduction/" class="">简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/table-of-contents/" class="">Table of Contents</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/table-of-contents/with-toc/" class="">With ToC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/table-of-contents/without-toc/" class="">Without ToC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e95c4460caffb600f4fbaa5e481c2b3b" class="toggle"  />
    <label for="section-e95c4460caffb600f4fbaa5e481c2b3b" class="flex justify-between">
      <a  class="">Collapsed</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/collapsed/3rd-level/" class="">3rd Level</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/collapsed/3rd-level/4th-level/" class="">4th Level</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d4bb91610a9265767097cfd2097f9869" class="toggle"  />
    <label for="section-d4bb91610a9265767097cfd2097f9869" class="flex justify-between">
      <a  class="">Compiler</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/aliases-simple-and-efficient/" class="">aliases, simple and efficient</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/builds-linkers-timeline/" class="">builds &amp; linker&#34;s timeline</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/built-in-functions-optimizations/" class="">built-in functions optimizations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/how-go-build-works/" class="">how &#34;go build&#34; works</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/how-are-loops-translated-to-assembly/" class="">how are loops translated to assembly</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/how-to-take-advantage-of-symbols-tables/" class="">how to take advantage of symbols tables</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/inline-strategy-limitation/" class="">inline strategy &amp; limitation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/introduction-to-the-escape-analysis/" class="">introduction to the escape analysis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/introduction-to-the-go-compiler/" class="">introduction to the go compiler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/introduction-to-the-go-compiler-ssa-backend/" class="">introduction to the go compiler ssa backend</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/memory-safety-with-bounds-check/" class="">memory safety with bounds check</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/overview-of-the-compiler/" class="">overview of the compiler</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/slice-and-memory-management/" class="">slice and memory management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://hitzhangjie.pro/docs/compiler/understanding-compiler-directives/" class="">understanding compiler directives</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f31e09d220fe3252a0eb99bdea817893" class="toggle"  />
    <label for="section-f31e09d220fe3252a0eb99bdea817893" class="flex justify-between">
      <a  class="">Runtime</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>











<hr>


  
<ul>
  
  <li>
    <a href="/posts/" >
        Posts
      </a>
  </li>
  
  <li>
    <a href="https://github.com/hitzhangjie/go-internals-v2" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://hitzhangjie.pro" target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>map, race detector</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/tags/ast/">ast</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/chan/">chan</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/chan-select-case/">chan, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/closure/">closure</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/compiler/">compiler</a>
          <span>24</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/compiler-linker/">compiler, linker</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/concurrency/">concurrency</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/context/">context</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/debug/">debug</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer/">defer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer-panic/">defer, panic</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer-panic-recover/">defer, panic, recover</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/diagnostics/">diagnostics</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/fuzzy-test/">fuzzy, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/garbage-collector/">garbage collector</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine/">goroutine</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine-gpm-scheduler/">goroutine, gpm scheduler</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine-select-case/">goroutine, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/gpm-scheduler/">gpm scheduler</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/init/">init</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/instrumentation/">instrumentation</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/interface/">interface</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/linker/">linker</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/locks/">locks</a>
          <span>3</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/map/">map</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/map-race-detector/">map, race detector</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/mechanics/">mechanics</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/memory-management/">memory management</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/monitor/">monitor</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/pointer/">pointer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/pprof/">pprof</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/race-detector/">race detector</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/random/">random</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/string/">string</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/sync.pool/">sync.pool</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/syscall/">syscall</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/tdd-test/">tdd, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/test/">test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/timer/">timer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/trace/">trace</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/unsafe/">unsafe</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  
  <article class="markdown book-post">
    <h2>
      <a href="/posts/concurrent-access-with-maps-part-3/">concurrent access with maps - part 3</a>
    </h2>
    


  

  
  <div>
    
      <a href="/tags/map-race-detector/">map, race detector</a>
  </div>
  




    <p>Let&rsquo;s Summarize #  1 map
map中的并发读写问题，go提供了如下方式进行检查：
  data race detection：通过选项-race来检测是否存在data race，关于data race检测的问题，kavya joshi的分享里有介绍；
  并发写操作检测：map对应的数据结构hmap中有个字段flags来记录当前的map操作，比如当前执行m[1]=1，是一个kv的赋值，对应的函数是mapassign_fast64，如果执行的是delete(m, 1)，对应的函数是mapdelete_fast64，这里的map修改操作对应的函数内部会将hmap.flags^=hashWriting，如果已经有一个写操作在执行，后面又有一个写操作执行，后面的写操作就有很大概率检测到flags的hashWriting位被设置了，此时就会抛出错误“concurrent map writes”错误；
  关于map为什么不直接提供并发安全的版本，原因也简单。并发安全的版本是有同步开销的，但是很多时候并不需要并发安全的版本，如果默认实现是并发安全的，性能上就要大打折扣了。不考虑并发安全问题的话，map比sync.Map要快7~10倍。
2 sync.Map
sync.Map是并发安全的实现，它对某些场景下的并发读写做了性能方面的优化： goblogs: &ldquo;The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, (2) when multiple goroutines read, write and overwrite entries for disjoint sets of keys.
        <a href="/posts/concurrent-access-with-maps-part-3/">...</a>
      
    </p>
  </article>
  

  


 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

  



  
    
  
    
  



<div class="book-languages" tabindex="0" aria-haspopup="true">
  <ul>
    <li class="flex align-center">
      <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
      Chinese
    </li> 
  </ul>

  <ul class="book-languages-list">
    
    <li class="active">
      <a href="https://hitzhangjie.pro/" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        Chinese
      </a>
    </li>
    
    <li class="">
      <a href="https://hitzhangjie.pro/en/" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </li>
    
  </ul>
</div>






</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  <nav>
  <ul>
  
    
    <li class="book-section-flat">
      <strong>Categories</strong>
      <ul>
      
      </ul>
    </li>
    
  
    
    <li class="book-section-flat">
      <strong>Tags</strong>
      <ul>
      
        <li class="flex justify-between">
          <a href="/tags/ast/">ast</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/chan/">chan</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/chan-select-case/">chan, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/closure/">closure</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/compiler/">compiler</a>
          <span>24</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/compiler-linker/">compiler, linker</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/concurrency/">concurrency</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/context/">context</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/debug/">debug</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer/">defer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer-panic/">defer, panic</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/defer-panic-recover/">defer, panic, recover</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/diagnostics/">diagnostics</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/fuzzy-test/">fuzzy, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/garbage-collector/">garbage collector</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine/">goroutine</a>
          <span>11</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine-gpm-scheduler/">goroutine, gpm scheduler</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/goroutine-select-case/">goroutine, select-case</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/gpm-scheduler/">gpm scheduler</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/init/">init</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/instrumentation/">instrumentation</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/interface/">interface</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/linker/">linker</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/locks/">locks</a>
          <span>3</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/map/">map</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/map-race-detector/">map, race detector</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/mechanics/">mechanics</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/memory-management/">memory management</a>
          <span>4</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/monitor/">monitor</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/pointer/">pointer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/pprof/">pprof</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/race-detector/">race detector</a>
          <span>2</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/random/">random</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/string/">string</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/sync.pool/">sync.pool</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/syscall/">syscall</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/tdd-test/">tdd, test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/test/">test</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/timer/">timer</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/trace/">trace</a>
          <span>1</span>
        </li>
      
        <li class="flex justify-between">
          <a href="/tags/unsafe/">unsafe</a>
          <span>1</span>
        </li>
      
      </ul>
    </li>
    
  
  </ul>
</nav>

 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












