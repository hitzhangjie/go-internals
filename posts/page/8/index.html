<!doctype html><html lang=zh dir=ltr>
<head>
<meta name=generator content="Hugo 0.91.2">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content>
<meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Posts">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:url" content="https://hitzhangjie.pro/go-internals-v2/posts/">
<title>Posts | Go设计实现内幕</title>
<link rel=manifest href=/go-internals-v2/manifest.json>
<link rel=icon href=/go-internals-v2/favicon.png type=image/x-icon>
<link rel=stylesheet href=/go-internals-v2/book.min.68be0b7a9674f2a612ce0e9b2e9447ff4b7ac96546e06b642bfd3ded0ca490ef.css integrity="sha256-aL4LepZ08qYSzg6bLpRH/0t6yWVG4GtkK/097QykkO8=">
<script defer src=/go-internals-v2/zh.search.min.c502cc1e7867019d317c0e03340c047979077d04edc8262eb7f9f698703fb60a.js integrity="sha256-xQLMHnhnAZ0xfA4DNAwEeXkHfQTtyCYut/n2mHA/tgo="></script>
<link rel=alternate type=application/rss+xml href=https://hitzhangjie.pro/go-internals-v2/posts/index.xml title=Go设计实现内幕>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a href=/go-internals-v2><img src=/go-internals-v2/logo.png alt=Logo><span>Go设计实现内幕</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/preface/>前言</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/introduction/>简介</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/setup/>准备</a>
</li>
<li>
<input type=checkbox id=section-a0d8d71f426b3018d3ea2b0d39cb80dd class=toggle>
<label for=section-a0d8d71f426b3018d3ea2b0d39cb80dd class="flex justify-between">
<a>Specification</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Specification/go-spec/>go spec</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-5b4c35c78aaa50e4262cf5f000ff643f class=toggle>
<label for=section-5b4c35c78aaa50e4262cf5f000ff643f class="flex justify-between">
<a>Toolchain</a>
</label>
<ul>
<li>
<input type=checkbox id=section-1478ad0225f3c1062830d9c09d8b93f3 class=toggle>
<label for=section-1478ad0225f3c1062830d9c09d8b93f3 class="flex justify-between">
<a>Compiler</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/aliases-simple-and-efficient/>aliases, simple and efficient</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/builds-linkers-timeline/>builds & linker"s timeline</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/built-in-functions-optimizations/>built-in functions optimizations</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/how-go-build-works/>how "go build" works</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/how-are-loops-translated-to-assembly/>how are loops translated to assembly</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/how-to-take-advantage-of-symbols-tables/>how to take advantage of symbols tables</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/inline-strategy-limitation/>inline strategy & limitation</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/introduction-to-the-escape-analysis/>introduction to the escape analysis</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/introduction-to-the-go-compiler/>introduction to the go compiler</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/introduction-to-the-go-compiler-ssa-backend/>introduction to the go compiler ssa backend</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/language-semantics-on-escape-analysis/>language semantics on escape analysis</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/memory-safety-with-bounds-check/>memory safety with bounds check</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/overview-of-the-compiler/>overview of the compiler</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/slice-and-memory-management/>slice and memory management</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Compiler/understanding-compiler-directives/>understanding compiler directives</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-7e4c79944057f12c630cadb7f66ae71d class=toggle>
<label for=section-7e4c79944057f12c630cadb7f66ae71d class="flex justify-between">
<a>Linker</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Linker/build-a-better-linker/>build a better linker</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Linker/builds-linkers-timeline/>builds & linker"s timeline</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Linker/how-go-build-works/>how "go build" works</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/Linker/object-file-relocations/>object file & relocations</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-ff16c11cae45273096ca6b9016ad8f91 class=toggle>
<label for=section-ff16c11cae45273096ca6b9016ad8f91 class="flex justify-between">
<a>Abi</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/ABI/go-register-ABI/>go register ABI</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-92155f78ab2fea96864dc8e5f605cf23 class=toggle>
<label for=section-92155f78ab2fea96864dc8e5f605cf23 class="flex justify-between">
<a>Ast</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/AST/visualize-your-go-code/>visualize your go code</a>
</li>
</ul>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Toolchain/instrumentation-in-go/>instrumentation in go</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-2cf4e97d00d6e0846a455aed8f898520 class=toggle>
<label for=section-2cf4e97d00d6e0846a455aed8f898520 class="flex justify-between">
<a>Memory</a>
</label>
<ul>
<li>
<input type=checkbox id=section-93dba9f40586c2c35d783752f434d3fe class=toggle>
<label for=section-93dba9f40586c2c35d783752f434d3fe class="flex justify-between">
<a>Memory Allocation</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/MemoryAllocation/demystifying-memory-management-in-modern-programming-languages/>demystifying memory management in modern programming languages</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/MemoryAllocation/memory-management-and-allocation/>memory management and allocation</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/MemoryAllocation/memory-management-and-memory-sweep/>memory management and memory sweep</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/MemoryAllocation/slice-and-memory-management/>slice and memory management</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/MemoryAllocation/visualizing-memory-management-in-go/>visualizing memory management in go</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-c7a4c22522235f51a39ce7f70ed7225e class=toggle>
<label for=section-c7a4c22522235f51a39ce7f70ed7225e class="flex justify-between">
<a>Garbage Collection</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/an-insight-into-go-garbage-collector/>an insight into go garbage collector</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/finalizers/>finalizers</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/go-GC-latency-problem-solved/>go GC: latency problem solved</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/go-GC-prioritizing-low-latency-and-simplicity/>go GC: prioritizing low latency and simplicity</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/how-does-GC-mark-the-memory/>how does GC mark the memory</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/how-does-GC-watch-your-application/>how does GC watch your application</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/how-does-go-stop-the-world/>how does go stop the world</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/keeping-a-variable-alive/>keeping a variable alive</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/memory-management-and-allocation/>memory management and allocation</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/memory-management-and-memory-sweep/>memory management and memory sweep</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/the-garbage-collection-handbook/>the garbage collection handbook</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/the-rules-of-unsafe.Pointer-and-uintptr/>the rules of unsafe.Pointer and uintptr</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Memory/GarbageCollection/tracing-garbage-collection/>tracing garbage collection</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-52225bc65f7b2a78999589b1479ab0c3 class=toggle>
<label for=section-52225bc65f7b2a78999589b1479ab0c3 class="flex justify-between">
<a>Goroutine</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/asynchronous-preemption/>asynchronous preemption</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/concurrency-scheduler-affinity/>concurrency & scheduler affinity</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/g0-special-goroutines/>g0, special goroutines</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/goroutine-and-preemption/>goroutine and preemption</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/goroutine-os-thread-and-cpu-management/>goroutine, os thread, and cpu management</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/gsignal-master-of-signals/>gsignal, master of signals</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/how-does-a-goroutine-start-and-exit/>how does a goroutine start and exit</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/how-does-go-recycle-goroutines/>how does go recycle goroutines</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/how-goroutine-stack-size-evolve/>how goroutine stack size evolve</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/improve-the-usage-of-your-goroutines-with-GODEBUG/>improve the usage of your goroutines with GODEBUG</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/observing-stack-grow-and-shrink/>observing stack grow and shrink</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/what-does-a-goroutine-switch-actually-involve/>what does a goroutine switch actually involve</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Goroutine/work-stealing-in-go-scheduler/>work-stealing in go scheduler</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-f31e09d220fe3252a0eb99bdea817893 class=toggle>
<label for=section-f31e09d220fe3252a0eb99bdea817893 class="flex justify-between">
<a>Runtime</a>
</label>
<ul>
<li>
<input type=checkbox id=section-6af4e9ddadfe05b53d5ba165c38f1e3e class=toggle>
<label for=section-6af4e9ddadfe05b53d5ba165c38f1e3e class="flex justify-between">
<a>Scheduler</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/concurrency-scheduler-affinity/>concurrency & scheduler affinity</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/GOMAXPROCS-live-updates/>GOMAXPROCS & live updates</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/scheduling-in-go-part-i-os-scheduler/>scheduling in go: part i - os scheduler</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/scheduling-in-go-part-ii-go-scheduler/>scheduling in go: part ii - go scheduler</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/scheduling-in-go-part-iii-concurrency/>scheduling in go: part iii - concurrency</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Scheduler/work-stealing-in-go-scheduler/>work-stealing in go scheduler</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-825adbd2b838041eea46d2a10adc5f9a class=toggle>
<label for=section-825adbd2b838041eea46d2a10adc5f9a class="flex justify-between">
<a>Monitor</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/Monitor/monitor-pattern/>monitor pattern</a>
</li>
</ul>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/runtime/a-whirlwind-tour-of-Gos-runtime-environment-variables/>a whirlwind tour of Go’s runtime environment variables</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-93d588918944a298d3f4270e6df9e968 class=toggle>
<label for=section-93d588918944a298d3f4270e6df9e968 class="flex justify-between">
<a>Synchronization</a>
</label>
<ul>
<li>
<input type=checkbox id=section-e4f56fa00191ca8306d1438c969bef3e class=toggle>
<label for=section-e4f56fa00191ca8306d1438c969bef3e class="flex justify-between">
<a>Locks</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Synchronization/Locks/how-to-reduce-lock-contention-with-the-atomic-package/>how to reduce lock contention with the atomic package</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Synchronization/Locks/locks-sync.Mutex-internals/>locks: sync.Mutex internals</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Synchronization/Locks/mutex-and-starvation/>mutex and starvation</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-d90698102847b301cf3137d159da1529 class=toggle>
<label for=section-d90698102847b301cf3137d159da1529 class="flex justify-between">
<a>Race Detection</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Synchronization/RaceDetection/a-race-detector-unfurled/>a race detector unfurled</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Synchronization/RaceDetection/race-detector-with-thread-sanitizer/>race detector with thread sanitizer</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-8c09d3d57dd5ee0090220d9bf96ec092 class=toggle>
<label for=section-8c09d3d57dd5ee0090220d9bf96ec092 class="flex justify-between">
<a>Diagnostics</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Diagnostics/diagnostics-methods/>Diagnostics Methods</a>
</li>
<li>
<input type=checkbox id=section-1c55d6e534f174d1a9d86e1f0d27011e class=toggle>
<label for=section-1c55d6e534f174d1a9d86e1f0d27011e class="flex justify-between">
<a>Debugging</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Diagnostics/Debugging/debugging-with-delve-coredumps/>debugging with delve & coredumps</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-25c014c40c4708b8f9b278eab857403a class=toggle>
<label for=section-25c014c40c4708b8f9b278eab857403a class="flex justify-between">
<a>PProf</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Diagnostics/PProf/language-semantics-on-memory-profiling/>language semantics on memory profiling</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Diagnostics/PProf/samples-collection-with-pprof/>samples collection with pprof</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-ef57056641f9c66c69d93a6c9fc4c689 class=toggle>
<label for=section-ef57056641f9c66c69d93a6c9fc4c689 class="flex justify-between">
<a>Tracing</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Diagnostics/Tracing/discovery-of-the-trace-package/>discovery of the trace package</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-51db080d4a3f95e2e371c478fda59b4e class=toggle>
<label for=section-51db080d4a3f95e2e371c478fda59b4e class="flex justify-between">
<a>Testing</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Testing/Benchmarking-in-Golang-Improving-function-performance/>Benchmarking in Golang: Improving function performance</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Testing/learn-go-with-tests/>learn-go-with-tests</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Testing/practical-fuzzing-with-go/>practical fuzzing with go</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Testing/unknown-parts-of-the-test-package/>unknown parts of the test package</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-129195bb7d4d59f2206f00e863a8ebdb class=toggle>
<label for=section-129195bb7d4d59f2206f00e863a8ebdb class="flex justify-between">
<a>Builtins</a>
</label>
<ul>
<li>
<input type=checkbox id=section-651c7afe116c240343430442fd77600a class=toggle>
<label for=section-651c7afe116c240343430442fd77600a class="flex justify-between">
<a>Chan</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/chan/buffered-and-unbuffered-channels/>buffered and unbuffered channels</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/chan/ordering-in-select-statements/>ordering in select statements</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-8e712e14ba6fe05a22de8ae756efc620 class=toggle>
<label for=section-8e712e14ba6fe05a22de8ae756efc620 class="flex justify-between">
<a>Map</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/map/concurrent-access-with-maps-part-3/>concurrent access with maps - part 3</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/map/map-design-by-code-part-1/>map design by code - part 1</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/map/map-design-by-code-part-2/>map design by code - part 2</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-631a92c08b04d863b1a494f36d547be5 class=toggle>
<label for=section-631a92c08b04d863b1a494f36d547be5 class="flex justify-between">
<a>Unsafe</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/unsafe/what-is-the-unsafe-package/>what is the unsafe package</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-a30ce872f66ddfa47ddd53e71fd3fd9b class=toggle>
<label for=section-a30ce872f66ddfa47ddd53e71fd3fd9b class="flex justify-between">
<a>Closure</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/closure/how-does-go-implement-closures/>how does go implement closures</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-89e63630549fc7d7179c5ff90b10c96f class=toggle>
<label for=section-89e63630549fc7d7179c5ff90b10c96f class="flex justify-between">
<a>Constants</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/constants/learn-go-constants-a-visual-guide/>learn go constants - a visual guide</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-09774e50ad4b214a713fa8f577f26533 class=toggle>
<label for=section-09774e50ad4b214a713fa8f577f26533 class="flex justify-between">
<a>Context</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/context/context-and-cancellation-by-propagation/>context and cancellation by propagation</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-e85e2a8e1719b54415998cfeaa4c64c5 class=toggle>
<label for=section-e85e2a8e1719b54415998cfeaa4c64c5 class="flex justify-between">
<a>Defer</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/defer/defer-internals/>defer internals</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/defer/how-does-defer-statement-work/>how does defer statement work</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-48164f93f23fb4774ca384e9dc84f94d class=toggle>
<label for=section-48164f93f23fb4774ca384e9dc84f94d class="flex justify-between">
<a>Init</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/init/init-functions/>init functions</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-982535b748a0cf94fc4e363a4220c45e class=toggle>
<label for=section-982535b748a0cf94fc4e363a4220c45e class="flex justify-between">
<a>Interface</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/interface/understand-the-empty-interface/>understand the empty interface</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-95d1523b99d14914e1c43fbb32ebdfa3 class=toggle>
<label for=section-95d1523b99d14914e1c43fbb32ebdfa3 class="flex justify-between">
<a>Panic&Recover</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/panicrecover/how-does-a-program-recover/>how does a program recover</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-41006be660761bf1634dc3afef87d119 class=toggle>
<label for=section-41006be660761bf1634dc3afef87d119 class="flex justify-between">
<a>Pointer</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/pointer/design-philosophy-on-data-and-semantics/>design philosophy on data and semantics</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/pointer/language-mechanics-on-stacks-and-pointers/>language mechanics on stacks and pointers</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/pointer/should-i-use-pointer-instead-of-a-copy-of-struct/>should i use pointer instead of a copy of struct</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-518237b5864e05a88795053dc0aadf7a class=toggle>
<label for=section-518237b5864e05a88795053dc0aadf7a class="flex justify-between">
<a>Pool</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/pool/understand-the-design-of-sync.pool/>understand the design of sync.pool</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-02c17940ee18fd0e28da376b638e2d61 class=toggle>
<label for=section-02c17940ee18fd0e28da376b638e2d61 class="flex justify-between">
<a>Random</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/random/how-are-random-numbers-generated/>how are random numbers generated</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-9eb4f02a7524818c4c71d8579f485a0a class=toggle>
<label for=section-9eb4f02a7524818c4c71d8579f485a0a class="flex justify-between">
<a>String</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/string/string-conversion-optimization/>string & conversion optimization</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-5fd51849c5efc7c80caa0bfef5a0f76f class=toggle>
<label for=section-5fd51849c5efc7c80caa0bfef5a0f76f class="flex justify-between">
<a>Syscall</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/syscall/how-does-go-runtime-handles-syscall/>how does go runtime handles syscall</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-dc98d3d867181a4b7f4594d457e17777 class=toggle>
<label for=section-dc98d3d867181a4b7f4594d457e17777 class="flex justify-between">
<a>Timer</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Builtins/timer/timers-life-cycle/>timers" life cycle</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-54ff0ab7dec4280864e76f3fd0b3d0c8 class=toggle>
<label for=section-54ff0ab7dec4280864e76f3fd0b3d0c8 class="flex justify-between">
<a>Patterns</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Patterns/rethinking-classical-concurrency-patterns/>rethinking classical concurrency patterns</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-9e07a1bfbe561ed3f6806c311a77856d class=toggle>
<label for=section-9e07a1bfbe561ed3f6806c311a77856d class="flex justify-between">
<a>Infrastructure</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Infrastructure/what-is-a-goproxy/>what is a goproxy</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Infrastructure/playing-with-go-module-proxy/>playing with go module proxy</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-ce52ab5a3ea7b9d335993e1906973892 class=toggle>
<label for=section-ce52ab5a3ea7b9d335993e1906973892 class="flex justify-between">
<a>Plugins</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Plugins/go-plugin-system/>go plugin system</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-f126f3c1abfdb1f388f4aa1d63bf636e class=toggle>
<label for=section-f126f3c1abfdb1f388f4aa1d63bf636e class="flex justify-between">
<a>Types</a>
</label>
<ul>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Types/duck-typing-structural-typing-nominal-typing/>duck typing, structural typing, nominal typing</a>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/Types/structural-typing-and-norminal-typing/>structural typing and norminal typing</a>
</li>
</ul>
</li>
<li>
<a href=https://hitzhangjie.pro/go-internals-v2/docs/SUMMARY/>Summary</a>
</li>
</ul>
<hr>
<ul>
<li>
<a href=/go-internals-v2/posts/>
Posts
</a>
</li>
<li>
<a href=https://github.com/hitzhangjie/go-internals-v2 target=_blank rel=noopener>
Github
</a>
</li>
<li>
<a href=https://hitzhangjie.pro target=_blank rel=noopener>
Blog
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/go-internals-v2/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Posts</strong>
<label for=toc-control>
<img src=/go-internals-v2/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav>
<ul>
<li class=book-section-flat>
<strong>Categories</strong>
<ul>
</ul>
</li>
<li class=book-section-flat>
<strong>Tags</strong>
<ul>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/abi/>abi</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/ast/>ast</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/chan/>chan</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/chan-select-case/>chan, select-case</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/closure/>closure</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/compiler/>compiler</a>
<span>25</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/compiler-linker/>compiler, linker</a>
<span>6</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/concurrency/>concurrency</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/context/>context</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/debug/>debug</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer/>defer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer-panic/>defer, panic</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer-panic-recover/>defer, panic, recover</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/design/>design</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/diagnostics/>diagnostics</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/fuzzy-test/>fuzzy, test</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/garbage-collector/>garbage collector</a>
<span>23</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goproxy/>goproxy</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine/>goroutine</a>
<span>23</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine-gpm-scheduler/>goroutine, gpm scheduler</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine-select-case/>goroutine, select-case</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/gpm-scheduler/>gpm scheduler</a>
<span>8</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/init/>init</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/install/>install</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/instrumentation/>instrumentation</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/interface/>interface</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/linker/>linker</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/locks/>locks</a>
<span>6</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/map/>map</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/map-race-detector/>map, race detector</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/mechanics/>mechanics</a>
<span>8</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/memory-management/>memory management</a>
<span>9</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/monitor/>monitor</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/plugin/>plugin</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/pointer/>pointer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/pprof/>pprof</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/race-detector/>race detector</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/random/>random</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/runtime/>runtime</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/string/>string</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/sync.pool/>sync.pool</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/syscall/>syscall</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/tdd-test/>tdd, test</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/test/>test</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/timer/>timer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/trace/>trace</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/types/>types</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/unsafe/>unsafe</a>
<span>2</span>
</li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/scheduling-in-go-part-ii-go-scheduler/>scheduling in go: part ii - go scheduler</a>
</h2>
<div>
<a href=/go-internals-v2/tags/gpm-scheduler/>gpm scheduler</a>
</div>
<p>Let&rsquo;s Summarize # GMP调度模型，P代表了逻辑核的数量，比如Intel酷睿i7处理器是支持超线程的，一个超线程可以认为是一个虚拟核，go运行时看到的核数实际是虚拟核的数量。/// GMP调度模型和操作系统调度器类比，后者是将线程调度到不同的处理器核上执行，前者是将不同的goroutines调度到不同的线程上执行。/// 操作系统调度器是抢占式调度，go运行时调度器在以前版本（1.14以前）是协作式调度，后面也支持了抢占式调度。/// go调度器什么时候检查要不要执行goroutines切换呢？有这么几个时机，使用go func(){}创建新的协程，执行GC，执行系统调用，执行同步操作。/// 介绍了上述几种情况下的一些调度细节。/// work stealing调度器工作方式，为什么没有用work sharing，后者需要用把全局锁或者其他同步措施来同步，是有开销的，而且还比较明显，另外容易破坏goroutines的调度粘性，影响执行效率。
Source Analysis # References # https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/scheduling-in-go-part-iii-concurrency/>scheduling in go: part iii - concurrency</a>
</h2>
<div>
<a href=/go-internals-v2/tags/gpm-scheduler/>gpm scheduler</a>
</div>
<p>Let&rsquo;s Summarize # 介绍了并行和并发的区别，介绍了工作负载类型的差别以及适合采用的提高效率的方式，计算密集型（CPU-bound）适合通过并行计算来提高效率，IO密集型（IO-bound）适合通过并发来提高计算效率。
Source Analysis # References # https://www.ardanlabs.com/blog/2018/12/scheduling-in-go-part3.html
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/should-i-use-pointer-instead-of-a-copy-of-struct/>should i use pointer instead of a copy of struct</a>
</h2>
<div>
<a href=/go-internals-v2/tags/pointer/>pointer</a>
</div>
<p>Let&rsquo;s Summarize # 什么时候使用pointer，什么时候使用value copy？
如果涉及密集的数据分配，适合用value copy而非指针，这样可以减少引入的GC开销； 而如果是涉及密集的函数调用，传参的时候适合用指针，可以减少值拷贝带来的开销； 总结一下，在涉及自动内存管理的语言中，使用指针代替值拷贝来提升性能的想法并不总是有效的，因为如果涉及的内存对象逃逸到了heap就会加重GC开销，如果作为函数参数的话，一般不涉及逃逸的情况，使用指针则可以减少值拷贝带来的开销，当然这里讨论的对象是些结构体之类相对较大的数据类型。
Source Analysis # References # https://medium.com/a-journey-with-go/go-should-i-use-a-pointer-instead-of-a-copy-of-my-struct-44b43b104963
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/slice-and-memory-management/>slice and memory management</a>
</h2>
<div>
<a href=/go-internals-v2/tags/compiler/>compiler</a>
</div>
<p>Let&rsquo;s Summarize # slice其结构用slice header来表示，包含data、len、cap 3个字段，这个很多文章提过了，现在提下slice操作中对内存操作方面的一点优化：
Copy：如果要删除slice nums中索引位置x中的元素，可以通过copy([x:],[x+1:])，然后x=[x:len(x)-1]来完成，也可以通过x = append(x[:x],[x+1:])来完成，这里会涉及到个别索引位置overlap的问题，编译器会转换成使用runtime.memmove来处理，这个函数会解决overlap的情况，比如从头拷贝会覆盖的话就用从后面拷贝来解决，实现稍复杂； Reset：有时一个slice被复用，复用之前希望清空它，可以写一个for循环把对应元素全部清0，我们可以这么写，编译器1.5之后会识别此类代码并将其转换为runtime.memclr*函数，这个效率比较高，应该是类似于memset之类的吧。 Allocate & Copy：其实新创建完一个slice时都会清0也是用的memclr*函数。如果是新创建完(make)之后立即跟着一个copy语句怎么办，那么清零就有点多余了，编译器也会识别这种情况，这种就不清零了。 go编译器一直在演进，让这门语言变得更加"聪明"！
Source Analysis # References # https://medium.com/a-journey-with-go/go-slice-and-memory-management-670498bb52be?source=---------4-----------------------
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/string-conversion-optimization/>string & conversion optimization</a>
</h2>
<div>
<a href=/go-internals-v2/tags/string/>string</a>
</div>
<p>Let&rsquo;s Summarize # b := genBytes() []byte { return []byte{&ldquo;a&rdquo;,&ldquo;b&rdquo;} }
switch string(b) { &mldr; }：这里的string(b)做了优化不会执行拷贝，直接用了原来b的底层数组做为string的底层数组；
访问map元素时：m := map[string]int{}, m[string(b)] 这里的key对应的string底层数组也是直接用的b的底层数组；
字符串连接时：println("("+string(b)+")")，这字符串连接结果肯定要分配新空间，但是string(b)自己是没有再分配新空间的；
字符串比较时：这种情况和switch时的比较类似，先比较string长度，再比较底层bytes数组长度，再比较string内容本身；
Source Analysis # References # https://medium.com/a-journey-with-go/go-string-conversion-optimization-767b019b75ef
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/the-garbage-collection-handbook/>the garbage collection handbook</a>
</h2>
<div>
<a href=/go-internals-v2/tags/memory-management/>memory management</a>
</div>
<p>Let&rsquo;s Summarize # Source Analysis # References # http://gchandbook.org/
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/the-rules-of-unsafe.Pointer-and-uintptr/>the rules of unsafe.Pointer and uintptr</a>
</h2>
<div>
<a href=/go-internals-v2/tags/garbage-collector/>garbage collector</a>
</div>
<p>Let&rsquo;s Summarize # unsafe.Pointer和uintptr可以互转，但是要注意转换时是否是有效的，有可能一个uintptr对应的对象已经被GC掉了，这个时候将其转换为指针其实是一个野指针。go编译器提供了一些patterns来识别什么时候unsafe.Pointer转为uintptr时不要让垃圾回收器GC掉指针对应的内存。
通常可以用go vet来检查一些误用情况，如果存在误用，会提示错误：possible misuse of unsafe.Pointer，但是只是possible misuse，不是misuse。
go vet也确实存在误报的情况，而且可能这个误报比率还有点高：https://github.com/golang/go/issues/41205.
这里也有人提过这个问题，如何绕过go vet检查：https://github.com/golang/go/issues/44836#issuecomment-792419407，但是我不建议使用这种方式，系统调用返回的uintptr如果是非go heap管理的，可以完全不用care go vet的误报，没必要为了绕过go vet的误报而做这种看上去有损可读性的编码。
Source Analysis # References # https://golang.org/pkg/unsafe/#Pointer
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/timers-life-cycle/>timers" life cycle</a>
</h2>
<div>
<a href=/go-internals-v2/tags/timer/>timer</a>
</div>
<p>Let&rsquo;s Summarize # time.AfterFunc(time.Second, func() {&mldr;})，注册timer的同时注册了一个callback，GMP模型里面，P有一个timers队列，我们创建的timer就被link到当前g.p的timers队列中。
scheduler调度过程中，也会检查timer，当timer到了执行时间时，需要执行对应的callback，这个callback不能在scheduler中执行，这会阻碍调度逻辑的正常执行。scheduler执行go callback()创建一个goroutine来执行。这个goroutine会被加入到当前g.p的localqueue中，等待被调度。
因为不是立即执行，所以callback的执行有一定的delay。如果某个goroutine在此goroutine之前执行，且有密集循环，以前协作式调度的时候可能callback执行的delay会比较明显。现在引入了抢占式调度，10ms一次抢占，因为密集循环导致的delay就没没那么明显了。
但是如果一个P上的timers很多或者goroutine很多，受限于g.p的localqueue的长度，timer上注册的callback的执行还是有可能会有明显的delay的。如何解决这个问题呢？
timer-stealing机制，一个P上的timers可以被其他P偷走来执行； work-stealing机制，一个P上的localqueue上的g可以被其他P偷走来执行； 通过这两种方式，有力减少了timer callback执行时的delay问题。
Source Analysis # References # https://medium.com/a-journey-with-go/go-timers-life-cycle-403f3580093a
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/tracing-garbage-collection/>tracing garbage collection</a>
</h2>
<div>
<a href=/go-internals-v2/tags/garbage-collector/>garbage collector</a>
</div>
<p>Let&rsquo;s Summarize # 介绍了常见的垃圾回收算法及优缺点，也进行了分类。
Source Analysis # References # https://en.wikipedia.org/wiki/Tracing_garbage_collection
</p>
</article>
<article class="markdown book-post">
<h2>
<a href=/go-internals-v2/posts/understand-the-design-of-sync.pool/>understand the design of sync.pool</a>
</h2>
<div>
<a href=/go-internals-v2/tags/sync.pool/>sync.pool</a>
</div>
<p>Let&rsquo;s Summarize # 1 sync.Pool设计
sync.Pool中有个local unsafe.Pointer字段，其实际类型为[P]poolLocal，当我们创建一个sync.Pool的时候，实际上是为每个P创建了一个poolLocal，每个P创建、获取对象时优先从Pool.poolLocal[p.id]中获取，这种类似的按照p.id执行sharding的方式可以有效减少lock intention，提高Pool的读写效率。
ps：准确地说，poolLocal.poolLocalInternal内部包含了private和shared字段，private只可以被当前pinned P访问，shared可以被所有P访问。这种设计有效减少了lock intention。
2 poolCleanup
sync.Pool有一个默认的poolCleanup函数，用于清理池子中不用的对象，以节省内存占用，在执行runtime.GC的时候，也会执行poolCleanup函数，当触发GC时，sync.Pool中的对象会被释放掉，一方面减少了内存占用，但是另一方面下次通过池子获取对象时又要申请内存，也会影响效率。
3 poolChain
go1.13中引入了一个lock-free的poolChain实现（poolLocalInternal.shared）和victim cache。
lock-free poolChain，pinned P在当前poolChain的head push/pop，只有当前P可以这么干，所以不需要同步措施；所有P都可以pop tail，需要做同步，这里是通过CAS原子操作来实现的。 这里的poolChain组织比较有意思，第一次是8个元素的deque，不够了申请16个元素的deque，并通过prev/next指针和之前的deque关联起来，第三次是32个……每次申请都是size直接double并通过指针串起来。因为poolChain.head只有当前P可操作，所以不需要同步，poolChain.tail允许多个P并发操作，用CAS原子操作来同步。
victim cache，runtime.GC()触发poolCleanup的时候，会将前一轮中poolLocal中分配的的对象赋值给victim这个cache，方便后面复用，怎么复用呢？ 当执行sync.Pool.Get()的时候：
先获取sync.Pool.local（实际是[P]poolLocal）的poolLocal[P.id].private有没有对象； 没有继续检查poolLocal[P.id].shared.popTail()有没有对象； 还没有就会尝试看看sync.Pool.victim中有没有； 还没有，就检查sync.Pool.New函数有没有定义，有则执行分配对象； 如果再下一轮runtime.GC()触发poolCleanup的时候，victim就会被干掉了。
ps：这里sync.Pool的设计比预想重要复杂些，可以再分析一下。
Source Analysis # References # https://medium.com/a-journey-with-go/go-understand-the-design-of-sync-pool-2dde3024e277?source=---------50-----------------------
</p>
</article>
<ul class="pagination pagination-default">
<li class=page-item>
<a href=/go-internals-v2/posts/ aria-label=First class=page-link role=button><span aria-hidden=true>&#171;&#171;</span></a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/7/ aria-label=Previous class=page-link role=button><span aria-hidden=true>&#171;</span></a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/5/ aria-label="Page 5" class=page-link role=button>5</a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/6/ aria-label="Page 6" class=page-link role=button>6</a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/7/ aria-label="Page 7" class=page-link role=button>7</a>
</li>
<li class="page-item active">
<a aria-current=page aria-label="Page 8" class=page-link role=button>8</a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/9/ aria-label="Page 9" class=page-link role=button>9</a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/9/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a>
</li>
<li class=page-item>
<a href=/go-internals-v2/posts/page/9/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a>
</li>
</ul>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
<div>
<a class="flex align-center" href=https://github.com/hitzhangjie/go-internals/edit/master//content/posts/_index.md target=_blank rel=noopener>
<img src=/go-internals-v2/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span>
</a>
</div>
</div>
</footer>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav>
<ul>
<li class=book-section-flat>
<strong>Categories</strong>
<ul>
</ul>
</li>
<li class=book-section-flat>
<strong>Tags</strong>
<ul>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/abi/>abi</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/ast/>ast</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/chan/>chan</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/chan-select-case/>chan, select-case</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/closure/>closure</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/compiler/>compiler</a>
<span>25</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/compiler-linker/>compiler, linker</a>
<span>6</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/concurrency/>concurrency</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/context/>context</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/debug/>debug</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer/>defer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer-panic/>defer, panic</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/defer-panic-recover/>defer, panic, recover</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/design/>design</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/diagnostics/>diagnostics</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/fuzzy-test/>fuzzy, test</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/garbage-collector/>garbage collector</a>
<span>23</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goproxy/>goproxy</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine/>goroutine</a>
<span>23</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine-gpm-scheduler/>goroutine, gpm scheduler</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/goroutine-select-case/>goroutine, select-case</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/gpm-scheduler/>gpm scheduler</a>
<span>8</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/init/>init</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/install/>install</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/instrumentation/>instrumentation</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/interface/>interface</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/linker/>linker</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/locks/>locks</a>
<span>6</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/map/>map</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/map-race-detector/>map, race detector</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/mechanics/>mechanics</a>
<span>8</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/memory-management/>memory management</a>
<span>9</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/monitor/>monitor</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/plugin/>plugin</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/pointer/>pointer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/pprof/>pprof</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/race-detector/>race detector</a>
<span>4</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/random/>random</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/runtime/>runtime</a>
<span>1</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/string/>string</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/sync.pool/>sync.pool</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/syscall/>syscall</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/tdd-test/>tdd, test</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/test/>test</a>
<span>3</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/timer/>timer</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/trace/>trace</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/types/>types</a>
<span>2</span>
</li>
<li class="flex justify-between">
<a href=/go-internals-v2/tags/unsafe/>unsafe</a>
<span>2</span>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>